<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Bill Calculator - OAuth Only</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 15px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .btn {
            padding: 12px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .btn-google {
            background: linear-gradient(135deg, #ea4335 0%, #fbbc05 100%);
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        .debug-log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status.success { background: #e8f5e8; color: #2e7d32; border-left: 4px solid #4caf50; }
        .status.error { background: #ffebee; color: #c62828; border-left: 4px solid #f44336; }
        .status.warning { background: #fff3e0; color: #f57c00; border-left: 4px solid #ff9800; }
        .status.info { background: #e3f2fd; color: #1565c0; border-left: 4px solid #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßæ Enhanced Bill Calculator - OAuth Only</h1>
            <p>‡πÉ‡∏ä‡πâ OAuth ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á API Key</p>
        </div>

        <!-- Configuration Status -->
        <div class="section">
            <h3>üìä Configuration Status</h3>
            <div id="configStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
        </div>

        <!-- Google API Status -->
        <div class="section">
            <h3>üîë Google OAuth Status</h3>
            <button class="btn btn-google" id="testGoogleApiBtn">üß™ Test OAuth Setup</button>
            <button class="btn btn-google" id="googleAuthBtn" disabled>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google</button>
            <div id="googleApiStatus" class="status info">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö...</div>
        </div>

        <!-- Google Drive Integration -->
        <div class="section">
            <h3>‚òÅÔ∏è Google Drive Integration</h3>
            <input type="url" id="googleDriveUrl" class="input" 
                placeholder="https://drive.google.com/drive/folders/..." 
                value="https://drive.google.com/drive/folders/1sSJdactN9akdC4cC93y9KuspmsaykDZh?usp=drive_link">
            <button class="btn btn-primary" id="fetchDriveBtn" disabled>üì• ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Drive</button>
            <div id="driveStatus" class="status info">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
        </div>

        <!-- File Upload (Alternative) -->
        <div class="section">
            <h3>üìÅ File Upload (Alternative)</h3>
            <input type="file" id="fileInput" class="input" accept="image/*" multiple>
            <button class="btn btn-primary" id="processBtn" disabled>‚ö° ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå</button>
        </div>

        <!-- Debug Log -->
        <div class="section">
            <h3>üîç Debug Log</h3>
            <button class="btn" onclick="clearDebugLog()">üßπ Clear Log</button>
            <div id="debugLog" class="debug-log">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö...\n</div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script type="module">
        // === OAuth-Only Configuration ===
        let CONFIG = {
            CLIENT_ID: "171730649633-qaa4lhi484g7srrbot6p394jq7an35h7.apps.googleusercontent.com",
            DISCOVERY_DOCS: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
            SCOPES: "https://www.googleapis.com/auth/drive.readonly"
        };

        // === Global Variables ===
        let isGapiLoaded = false;
        let isSignedIn = false;
        let selectedFiles = [];

        // === DOM Elements ===
        const configStatus = document.getElementById('configStatus');
        const testGoogleApiBtn = document.getElementById('testGoogleApiBtn');
        const googleAuthBtn = document.getElementById('googleAuthBtn');
        const googleApiStatus = document.getElementById('googleApiStatus');
        const googleDriveUrl = document.getElementById('googleDriveUrl');
        const fetchDriveBtn = document.getElementById('fetchDriveBtn');
        const driveStatus = document.getElementById('driveStatus');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const debugLog = document.getElementById('debugLog');

        // === Debug Functions ===
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            debugLog.textContent += logMessage;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(logMessage);
        }

        function setStatus(element, message, type = 'info') {
            element.className = `status ${type}`;
            element.textContent = message;
            log(`Status Update (${element.id}): ${message}`, type);
        }

        function clearDebugLog() {
            debugLog.textContent = 'Debug log cleared.\n';
        }

        // === Check Configuration ===
        function checkConfiguration() {
            log('Checking OAuth-only configuration...');
            
            const issues = [];
            
            if (!CONFIG.CLIENT_ID || CONFIG.CLIENT_ID.includes('YOUR_') || CONFIG.CLIENT_ID.includes('${{')) {
                issues.push('CLIENT_ID ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
            }
            
            if (issues.length > 0) {
                setStatus(configStatus, `‚ùå Configuration ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö: ${issues.join(', ')}`, 'error');
                log('Configuration issues found: ' + issues.join(', '), 'error');
                return false;
            } else {
                setStatus(configStatus, '‚úÖ OAuth Configuration ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á API Key)', 'success');
                log('OAuth Configuration OK - no API Key needed', 'success');
                return true;
            }
        }

        // === Test Google OAuth Setup ===
        testGoogleApiBtn.addEventListener('click', async () => {
            testGoogleApiBtn.disabled = true;
            testGoogleApiBtn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
            
            log('Testing Google OAuth setup...');
            
            try {
                if (!window.gapi) {
                    throw new Error('gapi not loaded');
                }
                
                log('gapi object found');
                setStatus(googleApiStatus, '‚úÖ Google API Script ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                
                // Load auth2 only (no client needed for OAuth-only approach)
                await new Promise((resolve, reject) => {
                    log('Loading gapi auth2...');
                    gapi.load('auth2', {
                        callback: resolve,
                        onerror: (err) => {
                            console.error('gapi.load error', err);
                            reject(new Error('Failed to load gapi auth2'));
                        }
                    });
                });
                
                log('gapi auth2 loaded successfully');
                
                // Initialize auth2 only
                const authInstance = await gapi.auth2.init({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES
                });
                
                log('gapi.auth2.init completed');
                
                if (authInstance) {
                    log('Auth instance created successfully');
                    setStatus(googleApiStatus, '‚úÖ Google OAuth ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
                    
                    googleAuthBtn.disabled = false;
                    isGapiLoaded = true;
                    
                    // Listen for sign-in state changes
                    authInstance.isSignedIn.listen(updateSigninStatus);
                    updateSigninStatus(authInstance.isSignedIn.get());
                    
                } else {
                    throw new Error('Failed to get auth instance');
                }
                
            } catch (error) {
                console.error("Full OAuth error object:", error); 
                const errorMessage = error?.result?.error?.message || error?.message || 'Unknown OAuth error';
                log(`Google OAuth test failed: ${errorMessage}`, 'error');
                setStatus(googleApiStatus, `‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${errorMessage}`, 'error');
            } finally {
                testGoogleApiBtn.disabled = false;
                testGoogleApiBtn.textContent = 'üß™ Test OAuth Setup';
            }
        });

        // === Google Sign-in ===
        googleAuthBtn.addEventListener('click', async () => {
            if (!isGapiLoaded) {
                setStatus(googleApiStatus, '‚ùå Google OAuth ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                
                if (!isSignedIn) {
                    log('Attempting to sign in...');
                    await authInstance.signIn();
                } else {
                    log('Attempting to sign out...');
                    await authInstance.signOut();
                }
                
            } catch (error) {
                log(`Sign-in/out error: ${error.message}`, 'error');
                setStatus(googleApiStatus, `‚ùå Sign-in error: ${error.message}`, 'error');
            }
        });

        // === Update Sign-in Status ===
        function updateSigninStatus(signedIn) {
            isSignedIn = signedIn;
            log(`Sign-in status changed: ${signedIn}`);
            
            if (signedIn) {
                googleAuthBtn.textContent = '‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö';
                googleAuthBtn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
                
                // Initialize Drive API client after successful sign-in
                initializeDriveAPI();
                
                setStatus(googleApiStatus, '‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                
                // Get user info
                const user = gapi.auth2.getAuthInstance().currentUser.get();
                const profile = user.getBasicProfile();
                log(`Signed in as: ${profile.getName()} (${profile.getEmail()})`);
                
            } else {
                googleAuthBtn.textContent = 'üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google';
                googleAuthBtn.style.background = 'linear-gradient(135deg, #ea4335 0%, #fbbc05 100%)';
                fetchDriveBtn.disabled = true;
                setStatus(googleApiStatus, '‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'warning');
            }
        }

        // === Initialize Drive API Client After Sign-in ===
        async function initializeDriveAPI() {
            try {
                log('Initializing Drive API client...');
                
                // Load gapi client
                await new Promise((resolve, reject) => {
                    gapi.load('client', {
                        callback: resolve,
                        onerror: reject
                    });
                });
                
                // Initialize client with minimal config (no API key needed with OAuth)
                await gapi.client.init({
                    discoveryDocs: CONFIG.DISCOVERY_DOCS
                });
                
                log('Drive API client initialized successfully');
                fetchDriveBtn.disabled = false;
                
            } catch (error) {
                log(`Failed to initialize Drive API: ${error.message}`, 'error');
                setStatus(googleApiStatus, `‚ùå Drive API init failed: ${error.message}`, 'error');
            }
        }

        // === Fetch from Google Drive ===
        fetchDriveBtn.addEventListener('click', async () => {
            const url = googleDriveUrl.value.trim();
            
            if (!url) {
                setStatus(driveStatus, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL Google Drive', 'error');
                return;
            }
            
            if (!url.includes('drive.google.com')) {
                setStatus(driveStatus, '‚ùå URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL Google Drive ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            const folderId = extractFolderId(url);
            if (!folderId) {
                setStatus(driveStatus, '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á Folder ID ‡πÑ‡∏î‡πâ', 'error');
                return;
            }
            
            log(`Extracting folder ID: ${folderId}`);
            
            fetchDriveBtn.disabled = true;
            fetchDriveBtn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            setStatus(driveStatus, '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå...', 'info');
            
            try {
                log('Listing files in Drive folder...');
                
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and (mimeType contains 'image/')`,
                    fields: 'files(id, name, mimeType, webContentLink, size)',
                    pageSize: 100
                });
                
                const files = response.result.files;
                log(`Found ${files.length} image files`);
                
                if (!files || files.length === 0) {
                    setStatus(driveStatus, '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Folder ‡∏ô‡∏µ‡πâ', 'warning');
                    return;
                }
                
                setStatus(driveStatus, `‚úÖ ‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${files.length} ‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...`, 'success');
                
                // Download files (limit to first 5 for testing)
                const limitedFiles = files.slice(0, 5);
                log(`Downloading ${limitedFiles.length} files...`);
                
                const downloadPromises = limitedFiles.map(async (file, index) => {
                    try {
                        log(`Downloading file ${index + 1}/${limitedFiles.length}: ${file.name}`);
                        
                        const resp = await gapi.client.drive.files.get({
                            fileId: file.id,
                            alt: 'media'
                        });
                        
                        // Convert response to blob
                        const arrayBuffer = new TextEncoder().encode(resp.body);
                        const blob = new Blob([arrayBuffer], { type: file.mimeType });
                        
                        if (blob.size === 0) {
                            log(`‚ùå File ${file.name} has zero size`, 'error');
                            return null;
                        }
                        
                        const fileObj = new File([blob], file.name, { type: file.mimeType });
                        
                        log(`Successfully downloaded: ${file.name} (${blob.size} bytes)`);
                        return fileObj;
                        
                    } catch (error) {
                        log(`Failed to download ${file.name}: ${error.message}`, 'error');
                        return null;
                    }
                });
                
                const downloadedFiles = await Promise.all(downloadPromises);
                const validFiles = downloadedFiles.filter(f => f !== null);
                
                if (validFiles.length > 0) {
                    selectedFiles = validFiles;
                    processBtn.disabled = false;
                    setStatus(driveStatus, `‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${validFiles.length} ‡πÑ‡∏ü‡∏•‡πå`, 'success');
                    log(`Ready to process ${validFiles.length} files`);
                } else {
                    setStatus(driveStatus, '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
                }
                
            } catch (error) {
                log(`Drive fetch error: ${error.message}`, 'error');
                setStatus(driveStatus, `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            } finally {
                fetchDriveBtn.disabled = false;
                fetchDriveBtn.textContent = 'üì• ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Drive';
            }
        });

        // === Extract Folder ID ===
        function extractFolderId(url) {
            const patterns = [
                /\/folders\/([a-zA-Z0-9-_]+)/,
                /[?&]id=([a-zA-Z0-9-_]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        // === File Input Handler ===
        fileInput.addEventListener('change', (event) => {
            const files = Array.from(event.target.files);
            selectedFiles = files;
            processBtn.disabled = files.length === 0;
            log(`Selected ${files.length} files via file input`);
        });

        // === Process Files ===
        processBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;
            
            log(`Starting to process ${selectedFiles.length} files...`);
            processBtn.disabled = true;
            processBtn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                log(`Processing file ${i + 1}/${selectedFiles.length}: ${file.name}`);
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('https://allie-capacitive-kaiden.ngrok-free.app/webhook/aip1', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`‚úÖ Processed successfully: ${file.name}`);
                        console.log('Response data:', data);
                    } else {
                        log(`‚ùå Failed to process ${file.name}: ${response.statusText}`, 'error');
                    }
                    
                } catch (error) {
                    log(`‚ùå Error processing ${file.name}: ${error.message}`, 'error');
                }
            }
            
            processBtn.disabled = false;
            processBtn.textContent = '‚ö° ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå';
            log('Processing completed!');
        });

        // === Initialize ===
        window.onload = async function() {
            log('Application starting with OAuth-only configuration...');

            // Try to load external config, but fallback to embedded config
            try {
                log('Attempting to load configuration from env.js...');
                const externalConfig = (await import('./env.js')).default;
                CONFIG = { ...CONFIG, ...externalConfig };
                log('Successfully loaded and merged env.js');
            } catch (e) {
                log('env.js not found, using embedded OAuth configuration', 'info');
            }
            
            // Check if Google API script is loaded
            if (window.gapi) {
                log('Google API script loaded successfully');
            } else {
                log('Google API script not loaded', 'error');
                setStatus(googleApiStatus, '‚ùå Google API Script ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î', 'error');
            }
            
            // Check configuration
            const configOK = checkConfiguration();
            
            if (!configOK) {
                log('Configuration incomplete - please check CLIENT_ID', 'error');
                testGoogleApiBtn.disabled = true;
            }
            
            log('Application initialization completed');
        };
    </script>
</body>
</html>