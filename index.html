<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Calculator with Google Drive Integration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 15px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .btn {
            padding: 12px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .btn-google {
            background: linear-gradient(135deg, #ea4335 0%, #fbbc05 100%);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        .debug-log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status.success { background: #e8f5e8; color: #2e7d32; border-left: 4px solid #4caf50; }
        .status.error { background: #ffebee; color: #c62828; border-left: 4px solid #f44336; }
        .status.warning { background: #fff3e0; color: #f57c00; border-left: 4px solid #ff9800; }
        .status.info { background: #e3f2fd; color: #1565c0; border-left: 4px solid #2196f3; }
        
        /* Google Sign-in Button Container */
        #googleSignInDiv {
            margin: 10px 0;
        }
        
        /* File Upload Area */
        .file-upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .file-upload-area:hover {
            border-color: #4facfe;
            background: #e3f2fd;
        }
        
        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            top: 0;
            left: 0;
        }
        
        .selected-files {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .selected-files .file-item {
            padding: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        /* Results Section */
        .results-container {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .result-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 3px 12px rgba(17, 153, 142, 0.3);
        }
        
        /* Table Styles */
        .horizontal-table-container {
            margin: 15px 0;
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .horizontal-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .horizontal-table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            font-size: 11px;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .horizontal-table tbody td {
            padding: 8px 6px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
            font-size: 11px;
            text-align: center;
            color: #333;
        }
        
        .horizontal-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .loading-container {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #ddd;
            border-top: 2px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .raw-data-container {
            max-height: 150px;
            overflow-y: auto;
            background: #f4f4f4;
            padding: 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
        }
        .btn-sm {
            padding: 5px 10px !important;
            font-size: 12px !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-sm:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßæ Bill Calculator with Google Drive</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ö‡∏¥‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive</p>
        </div>

        <!-- Configuration Status -->
        <div class="section">
            <h3>üìä Configuration Status</h3>
            <div id="configStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
        </div>

        <!-- Google API Status -->
        <div class="section">
            <h3>üîê Google OAuth Status</h3>
            <div id="googleSignInDiv"></div>
            <button class="btn btn-google" id="signOutBtn" style="display:none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            <div id="googleApiStatus" class="status info">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö...</div>
            <div id="userInfo" style="margin-top: 10px;"></div>
        </div>

        <!-- Google Drive Integration -->
        <div class="section">
            <h3>‚òÅÔ∏è Google Drive Integration</h3>
            <input type="url" id="googleDriveUrl" class="input" 
                placeholder="https://drive.google.com/drive/folders/..." 
                value="https://drive.google.com/drive/folders/1sSJdactN9akdC4cC93y9KuspmsaykDZh?usp=drive_link">
            <button class="btn btn-primary" id="fetchDriveBtn" disabled>üì• ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Drive</button>
            <div id="driveStatus" class="status info">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
        </div>

        <!-- File Upload Area -->
        <div class="section">
            <h3>üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ö‡∏¥‡∏•</h3>
            <div class="file-upload-area" id="fileUploadArea">
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                <span style="font-size: 48px;">üìÑ</span>
                <p><strong>‡∏Ñ‡∏•‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ Ctrl+V ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</strong></p>
                <p style="font-size: 12px; color: #666;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: JPG, PNG, WebP</p>
            </div>
            <div id="selectedFilesList" style="display:none;" class="selected-files"></div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-success" id="processBtn" disabled style="font-size: 16px; padding: 15px 30px;">
                    ‚ö° ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ MCP
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="section" id="resultsSection" style="display:none;">
            <h3>üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h3>
            <div id="resultsContainer" class="results-container"></div>
        </div>

        <!-- Debug Log -->
        <div class="section">
            <h3>üìã Debug Log</h3>
            <button class="btn" onclick="clearDebugLog()">üßπ Clear Log</button>
            <div id="debugLog" class="debug-log">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö...
</div>
        </div>
    </div>

    <!-- Google Identity Services ‡πÅ‡∏•‡∏∞ GAPI -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <script>
        // === OAuth Configuration ===
        const CONFIG = {
            CLIENT_ID: "171730649633-qaa4lhi484g7srrbot6p394jq7an35h7.apps.googleusercontent.com",
            DISCOVERY_DOCS: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
            SCOPES: "https://www.googleapis.com/auth/drive.readonly"
        };

        // === Global Variables ===
        let tokenClient;
        let accessToken = null;
        let selectedFiles = [];
        let driveFiles = [];

        // === DOM Elements ===
        const configStatus = document.getElementById('configStatus');
        const googleApiStatus = document.getElementById('googleApiStatus');
        const googleDriveUrl = document.getElementById('googleDriveUrl');
        const fetchDriveBtn = document.getElementById('fetchDriveBtn');
        const driveStatus = document.getElementById('driveStatus');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const debugLog = document.getElementById('debugLog');
        const userInfo = document.getElementById('userInfo');
        const signOutBtn = document.getElementById('signOutBtn');
        const selectedFilesList = document.getElementById('selectedFilesList');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsSection = document.getElementById('resultsSection');

        // === Debug Functions ===
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            debugLog.textContent += logMessage;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(logMessage);
        }

        function setStatus(element, message, type = 'info') {
            element.className = `status ${type}`;
            element.textContent = message;
            log(`Status Update (${element.id}): ${message}`, type);
        }

        function clearDebugLog() {
            debugLog.textContent = 'Debug log cleared.\n';
        }

        // === Initialize Google Identity Services ===
        function initializeGoogleIdentity() {
            log('Initializing Google Identity Services...');
            
            // Initialize for ID token (sign-in)
            google.accounts.id.initialize({
                client_id: CONFIG.CLIENT_ID,
                callback: handleCredentialResponse,
                auto_select: false
            });

            // Render Sign-in button
            google.accounts.id.renderButton(
                document.getElementById('googleSignInDiv'),
                { 
                    theme: "outline", 
                    size: "large",
                    text: "signin_with",
                    shape: "rectangular",
                    width: 250
                }
            );

            // Initialize OAuth2 token client for Drive API access
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: (tokenResponse) => {
                    log('OAuth token received successfully');
                    accessToken = tokenResponse.access_token;
                    
                    // Initialize GAPI client with the token
                    initializeGapiClient();
                },
            });

            setStatus(googleApiStatus, '‚úÖ Google Identity Services ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
            log('Google Identity Services initialized successfully');
        }

        // === Handle Sign-in Response ===
        function handleCredentialResponse(response) {
            log('Received credential response');
            if (response.credential) {
                // Decode JWT token to get user info
                const responsePayload = decodeJwtResponse(response.credential);
                
                userInfo.innerHTML = `
                    <strong>Signed in as:</strong> ${responsePayload.name} (${responsePayload.email})
                `;
                
                setStatus(googleApiStatus, '‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Drive...', 'success');
                
                // Show sign out button
                signOutBtn.style.display = 'inline-block';
                
                // After successful sign-in, request OAuth token for Drive access
                tokenClient.requestAccessToken();
            }
        }

        // === Decode JWT Token ===
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // === Initialize Gapi Client ===
        function initializeGapiClient() {
            log('Initializing GAPI client...');
            
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        discoveryDocs: CONFIG.DISCOVERY_DOCS
                    });
                    
                    // Set the access token
                    gapi.client.setToken({
                        access_token: accessToken
                    });
                    
                    log('GAPI client initialized successfully');
                    fetchDriveBtn.disabled = false;
                    setStatus(googleApiStatus, '‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Drive API', 'success');
                    
                } catch (error) {
                    log(`Failed to initialize GAPI client: ${error.message}`, 'error');
                    setStatus(googleApiStatus, `‚ùå GAPI init failed: ${error.message}`, 'error');
                }
            });
        }

        // === Sign Out ===
        signOutBtn.addEventListener('click', () => {
            google.accounts.id.disableAutoSelect();
            
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    log('Successfully signed out');
                    accessToken = null;
                    userInfo.innerHTML = '';
                    signOutBtn.style.display = 'none';
                    fetchDriveBtn.disabled = true;
                    setStatus(googleApiStatus, '‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'warning');
                });
            }
            
            // Reload to reset the sign-in button
            location.reload();
        });

        // === Fetch from Google Drive ===
        fetchDriveBtn.addEventListener('click', async () => {
            const url = googleDriveUrl.value.trim();
            
            if (!url) {
                setStatus(driveStatus, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL Google Drive', 'error');
                return;
            }
            
            const folderId = extractFolderId(url);
            if (!folderId) {
                setStatus(driveStatus, '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á Folder ID ‡πÑ‡∏î‡πâ', 'error');
                return;
            }
            
            log(`Extracting folder ID: ${folderId}`);
            
            fetchDriveBtn.disabled = true;
            fetchDriveBtn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            setStatus(driveStatus, '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå...', 'info');
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and (mimeType contains 'image/')`,
                    fields: 'files(id, name, mimeType, webContentLink, size)',
                    pageSize: 100
                });
                
                const files = response.result.files;
                log(`Found ${files.length} image files`);
                
                if (!files || files.length === 0) {
                    setStatus(driveStatus, '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Folder ‡∏ô‡∏µ‡πâ', 'warning');
                    return;
                }
                
                setStatus(driveStatus, `‚úÖ ‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${files.length} ‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...`, 'success');
                
                // Download files
                driveFiles = [];
                const downloadPromises = files.map(async (file, index) => {
                    try {
                        log(`Downloading file ${index + 1}/${files.length}: ${file.name}`);

                        if (!accessToken) {
                            throw new Error('No OAuth access token (accessToken is null). Please sign in and allow Drive access.');
                        }

                        const url = `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`;
                        const resp = await fetch(url, {
                            headers: { Authorization: `Bearer ${accessToken}` }
                        });

                        if (!resp.ok) {
                            const txt = await resp.text().catch(()=>'');
                            throw new Error(`HTTP ${resp.status} ${resp.statusText}${txt ? ' - '+txt.slice(0,200) : ''}`);
                        }

                        const blob = await resp.blob();
                        if (!blob || blob.size === 0) {
                            throw new Error('Downloaded blob is empty');
                        }

                        const fileObj = new File([blob], file.name, { type: file.mimeType });
                        return fileObj;
                    } catch (error) {
                        log(`Failed to download ${file.name}: ${error.message}`, 'error');
                        return null;
                    }
                });
                
                const downloadedFiles = await Promise.all(downloadPromises);
                driveFiles = downloadedFiles.filter(f => f !== null);
                
                if (driveFiles.length > 0) {
                    // Add to selected files
                    selectedFiles = [...selectedFiles, ...driveFiles];
                    updateSelectedFilesList();
                    setStatus(driveStatus, `‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${driveFiles.length} ‡πÑ‡∏ü‡∏•‡πå`, 'success');
                    log(`Ready to process ${driveFiles.length} files from Drive`);
                }
                
            } catch (error) {
                log(`Drive fetch error: ${error.message}`, 'error');
                setStatus(driveStatus, `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            } finally {
                fetchDriveBtn.disabled = false;
                fetchDriveBtn.textContent = 'üì• ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Drive';
            }
        });

        // === Extract Folder ID ===
        function extractFolderId(url) {
            const patterns = [
                /\/folders\/([a-zA-Z0-9-_]+)/,
                /[?&]id=([a-zA-Z0-9-_]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        // === File Input Handler ===
        fileInput.addEventListener('change', (event) => {
            const files = Array.from(event.target.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 0) {
                selectedFiles = [...selectedFiles, ...files];
                updateSelectedFilesList();
                log(`Selected ${files.length} files via file input`);
            }
        });

        // === Handle Paste Event ===
        document.addEventListener('paste', async (e) => {
            const dt = e.clipboardData || window.clipboardData;
            if (!dt) return;

            const files = [];
            if (dt.items && dt.items.length) {
                for (const item of dt.items) {
                    if (item.type && item.type.startsWith('image/')) {
                        const blob = item.getAsFile();
                        if (blob) {
                            const ext = blob.type.split('/')[1] || 'png';
                            const file = new File([blob], `pasted_${Date.now()}.${ext}`, { type: blob.type });
                            files.push(file);
                        }
                    }
                }
            }
            
            if (files.length > 0) {
                selectedFiles = [...selectedFiles, ...files];
                updateSelectedFilesList();
                log(`Pasted ${files.length} files from clipboard`);
                e.preventDefault();
            }
        });

        // === Update Selected Files List ===
        function updateSelectedFilesList() {
            if (selectedFiles.length === 0) {
                selectedFilesList.style.display = 'none';
                processBtn.disabled = true;
                return;
            }
            
            selectedFilesList.style.display = 'block';
            let html = `<strong>üì∏ ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (${selectedFiles.length} ‡πÑ‡∏ü‡∏•‡πå):</strong><br>`;
            
            selectedFiles.forEach((file, index) => {
                const kb = Math.round(file.size / 1024);
                const source = file.name.startsWith('pasted_') ? 'üìã' : 'üì∑';
                html += `<div class="file-item">${source} ${file.name} (${kb} KB)</div>`;
            });
            
            selectedFilesList.innerHTML = html;
            processBtn.disabled = false;
        }

        // === Process Files ===
        processBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;

            // ‡πÄ‡∏£‡∏¥‡πà‡∏° Resource Monitor
            createResourceMonitorUI();
            processStartTime = Date.now();
            filesProcessed = 0;
            totalBytesProcessed = 0;
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            document.getElementById('totalFiles').textContent = selectedFiles.length;


            processBtn.disabled = true;
            processBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
            resultsSection.style.display = 'block';
            resultsContainer.innerHTML = '';

            const startTimeAll = Date.now();
            const startDateAll = new Date(startTimeAll).toLocaleString('th-TH');

            // Create processing status UI (shows progress & per-task status)
            const statusDiv = createProcessingStatus(selectedFiles.length);

            // Process files in chunks (limit concurrency)
            const CONCURRENT_LIMIT = 10; // adjust as needed
            const chunks = [];
            for (let i = 0; i < selectedFiles.length; i += CONCURRENT_LIMIT) {
                chunks.push(selectedFiles.slice(i, i + CONCURRENT_LIMIT));
            }

            let processedCount = 0;
            const results = [];

            for (const chunk of chunks) {
                const promises = chunk.map(file => processSingleFile(file, statusDiv));
                const settled = await Promise.allSettled(promises);

                settled.forEach(s => {
                    processedCount++;
                    updateProgress(statusDiv, processedCount, selectedFiles.length);
                    if (s.status === 'fulfilled') results.push(s.value);
                });
            }

            // ‡∏•‡∏ö summary card ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
            const endTimeAll = Date.now();
            const endDateAll = new Date(endTimeAll).toLocaleString('th-TH');
            const durationAllSec = ((endTimeAll - startTimeAll) / 1000).toFixed(2);
            const durationAllMin = (durationAllSec / 60).toFixed(2);

            // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å loop ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à
            const successCount = results.filter(r => r.success).length;
            const failCount = results.length - successCount;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á summary ‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡πÅ‡∏ó‡∏ô summary card
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'result-card';
            summaryDiv.style.background = '#f0f4f8';
            summaryDiv.innerHTML = `
                <h4>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</h4>
                <hr style="margin: 10px 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <strong>${successCount}</strong> ‡πÑ‡∏ü‡∏•‡πå</div>
                    <div>‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: <strong>${failCount}</strong> ‡πÑ‡∏ü‡∏•‡πå</div>
                    <div>üìÅ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${selectedFiles.length}</strong> ‡πÑ‡∏ü‡∏•‡πå</div>
                    <div>‚è± ‡πÄ‡∏ß‡∏•‡∏≤: <strong>${durationAllSec}</strong> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (${durationAllMin} ‡∏ô‡∏≤‡∏ó‡∏µ)</div>
                </div>
                <hr style="margin: 10px 0;">
                <small style="color: #666;">
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°: ${startDateAll}<br>
                    ‡∏à‡∏ö: ${endDateAll}
                </small>`;
            resultsContainer.appendChild(summaryDiv); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î

            // ‡∏´‡∏¢‡∏∏‡∏î monitoring ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à
            setTimeout(() => {
                stopMonitoring();
                // ‡∏ã‡πà‡∏≠‡∏ô monitor ‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                setTimeout(() => {
                    const monitor = document.getElementById('resourceMonitor');
                    if (monitor) monitor.style.opacity = '0.7';
                }, 5000);
            }, 2000);
           

            processBtn.disabled = false;
            processBtn.textContent = '‚ö° ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ MCP';
            
            // Clear selected files after processing
            selectedFiles = [];
            updateSelectedFilesList();
        });

        // === Process Single File ===
        // now supports async jobs from server (polling) to wait until n8n finishes
        async function processSingleFile(file, statusDiv = null) {
            const startTime = Date.now();
            const taskId = `task_${file.name.replace(/\s+/g,'_')}_${Date.now()}`;

            if (statusDiv) updateTaskStatus(statusDiv, taskId, file.name, 'processing');

            const formData = new FormData();
            formData.append('file', file);

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'result-card';
            loadingDiv.id = `loading_${taskId}`;
            loadingDiv.innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå: <strong>${escapeHtml(file.name)}</strong>
                </div>`;
            resultsContainer.appendChild(loadingDiv);

            // Helper: poll a job URL until final result or timeout
            async function pollJob(jobUrl, timeoutMs = 60000) {
                const start = Date.now();
                let delay = 1000;
                while (Date.now() - start < timeoutMs) {
                    await new Promise(r => setTimeout(r, delay));
                    try {
                        log(`Polling job URL: ${jobUrl}`);
                        const r = await fetch(jobUrl, { headers: accessToken ? { Authorization: `Bearer ${accessToken}` } : {} });
                        const txt = await r.text().catch(()=>'');
                        if (!r.ok) {
                            log(`Poll returned HTTP ${r.status}`, 'info');
                        }
                        if (txt && txt.trim()) {
                            try {
                                const parsed = JSON.parse(txt);
                                // common patterns: { status: 'processing'|'completed', result: {...} } or direct result
                                if (parsed && typeof parsed === 'object') {
                                    if (parsed.status && parsed.status !== 'completed') {
                                        // still processing, continue polling
                                    } else if (parsed.result) {
                                        return parsed.result;
                                    } else {
                                        // assume parsed is final payload
                                        return parsed;
                                    }
                                }
                            } catch (e) {
                                // not JSON ‚Äî if body exists return it as-is (attempt)
                                return txt;
                            }
                        }
                        // backoff
                        delay = Math.min(delay * 1.8, 5000);
                    } catch (err) {
                        log(`Poll error: ${err.message}`, 'info');
                        delay = Math.min(delay * 1.8, 5000);
                    }
                }
                throw new Error('Timeout waiting for server to finish (polling)');
            }

            try {
                const apiBase = (CONFIG && CONFIG.API_ENDPOINT) ? String(CONFIG.API_ENDPOINT).replace(/\/+$/g, '') : '';
                const endpoint = apiBase ? `${apiBase}/webhook/aip1` : 'https://allie-capacitive-kaiden.ngrok-free.app/webhook/aip1';

                const res = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                const txt = await res.text().catch(()=>'');

                // If server indicates async via 202 or Location header, or body empty -> poll
                const locationHeader = res.headers.get('Location') || res.headers.get('location') || null;
                const asyncHeader = res.headers.get('X-Async-Job-Url') || res.headers.get('x-async-job-url') || null;

                let finalData = null;

                if (res.status === 202 || locationHeader || asyncHeader || !txt || txt.trim() === '') {
                    // Determine job URL
                    let jobUrl = asyncHeader || locationHeader;
                    if (!jobUrl) {
                        // try parse JSON for job id in body
                        try {
                            const maybe = txt ? JSON.parse(txt) : null;
                            if (maybe && (maybe.job_id || maybe.jobUrl || maybe.jobUrlRelative || maybe.statusUrl)) {
                                jobUrl = maybe.jobUrl || maybe.statusUrl || (maybe.job_id ? `${apiBase}/jobs/${maybe.job_id}` : null);
                            }
                        } catch (_) { /* ignore */ }
                    }

                    if (!jobUrl) {
                        // If no job URL, attempt polling a conventional status endpoint derived from original endpoint
                        jobUrl = endpoint.replace(/\/webhook.*$/, '/job-status') ;
                        log(`No job URL returned; using fallback poll endpoint: ${jobUrl}`, 'info');
                    } else if (jobUrl && jobUrl.startsWith('/')) {
                        // make absolute if relative
                        jobUrl = (apiBase || window.location.origin) + jobUrl;
                    }

                    updateTaskStatus(statusDiv, taskId, file.name, 'processing');
                    log(`Server returned async response; polling for result at ${jobUrl}`);
                    const polled = await pollJob(jobUrl, 90000); // wait up to 90s
                    finalData = polled;
                } else {
                    // synchronous response present ‚Äî try parse
                    if (!txt || txt.trim() === '') {
                        throw new Error('Empty response body from server');
                    }
                    try {
                        finalData = JSON.parse(txt);
                    } catch (e) {
                        // server returned non-JSON text but not empty; treat as error
                        throw new Error(`Invalid JSON response: ${txt.slice(0,300)}${txt.length>300?'...':''}`);
                    }
                }

                document.getElementById(`loading_${taskId}`)?.remove();

                const payload = Array.isArray(finalData) ? finalData[0] : finalData;
                if (!payload || typeof payload !== 'object') {
                    throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (final payload)');
                }

                if (statusDiv) updateTaskStatus(statusDiv, taskId, file.name, 'completed');

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó monitor
                filesProcessed++;
                totalBytesProcessed += file.size;

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó progress bar
                const progress = (filesProcessed / selectedFiles.length * 100).toFixed(0);
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${progress}%`;
                }
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å server
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å server ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
                const resultDiv = document.createElement('div');
                const uniqueId = `data_${taskId}`;
                resultDiv.className = 'result-card';
                resultDiv.innerHTML = `
                    <div class="status success">
                        ‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <strong>${escapeHtml(file.name)}</strong>
                        <button class="btn btn-sm" onclick="toggleRawData('${uniqueId}')" style="float: right; padding: 5px 10px; font-size: 12px;">
                            üìã ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                    <div id="${uniqueId}" class="raw-data-container" style="display: none; margin-top: 10px;">
                        ${JSON.stringify(payload, null, 2)}
                    </div>`;
                resultsContainer.appendChild(resultDiv);

                return { success: true, fileName: file.name, data: payload };

            } catch (error) {
                document.getElementById(`loading_${taskId}`)?.remove();
                if (statusDiv) updateTaskStatus(statusDiv, taskId, file.name, 'error');

                const errMsg = error?.message || String(error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'result-card';
                errorDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå <strong>${escapeHtml(file.name)}</strong><br>
                        <small>${escapeHtml(errMsg)}</small>
                    </div>`;
                resultsContainer.appendChild(errorDiv);

                console.error('processSingleFile error:', error);
                return { success: false, fileName: file.name, error: errMsg };
            }
        }

        // === Processing UI helpers (from index copy.html) ===
        function createProcessingStatus(totalFiles) {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'result-card';
            statusDiv.innerHTML = `
                <div class="processing-status">
                    <h4>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Parallel</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div id="progressText">0 / ${totalFiles} ‡πÑ‡∏ü‡∏•‡πå</div>
                    <div class="task-list" id="taskList"></div>
                </div>`;
            resultsContainer.insertBefore(statusDiv, resultsContainer.firstChild);
            return statusDiv;
        }

        function updateProgress(statusDiv, processed, total) {
            const progressFill = statusDiv.querySelector('#progressFill');
            const progressText = statusDiv.querySelector('#progressText');
            const percentage = Math.round((processed / total) * 100);
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${processed} / ${total} ‡πÑ‡∏ü‡∏•‡πå (${percentage}%)`;
        }

        function updateTaskStatus(statusDiv, taskId, fileName, status) {
            const taskList = statusDiv.querySelector('#taskList');
            let taskItem = taskList.querySelector(`[data-task-id="${taskId}"]`);
            if (!taskItem) {
                taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.setAttribute('data-task-id', taskId);
                taskList.appendChild(taskItem);
            }
            taskItem.className = `task-item ${status}`;
            const icons = { processing: '‚è≥', completed: '‚úÖ', error: '‚ùå' };
            const statusTexts = { processing: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', completed: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' };
            taskItem.innerHTML = `
                ${icons[status]} 
                <span style="font-weight: bold;">${escapeHtml(fileName.substring(0, 30))}</span>
                <span style="color: #666; font-size: 11px; margin-left:8px;">${statusTexts[status]}</span>
            `;
        }
        
        // === Export Functions ===
        function exportToCSV(data) {
            try {
                const csvData = flattenObjectForCSV(data);
                const headers = Object.keys(csvData);
                const values = headers.map(h => `"${String(csvData[h] ?? '').replace(/"/g, '""')}"`);
                
                const csvContent = [headers.join(','), values.join(',')].join('\n');
                downloadFile(csvContent, 'text/csv', 'invoice_data.csv');
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Export CSV');
                log(`Export CSV error: ${error.message}`, 'error');
            }
        }

        function exportToJSON(data) {
            try {
                const jsonContent = JSON.stringify(data, null, 2);
                downloadFile(jsonContent, 'application/json', 'invoice_data.json');
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Export JSON');
                log(`Export JSON error: ${error.message}`, 'error');
            }
        }

        function flattenObjectForCSV(obj, prefix = '') {
            let result = {};
            
            for (const [key, value] of Object.entries(obj)) {
                const newKey = prefix ? `${prefix}_${key}` : key;
                
                if (Array.isArray(value)) {
                    result[newKey] = JSON.stringify(value);
                } else if (typeof value === 'object' && value !== null) {
                    Object.assign(result, flattenObjectForCSV(value, newKey));
                } else {
                    result[newKey] = value;
                }
            }
            
            return result;
        }

        function downloadFile(content, mimeType, fileName) {
            const blob = new Blob([content], { type: `${mimeType};charset=utf-8;` });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // === Helper Functions ===
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // === Toggle Raw Data Function ===
        function toggleRawData(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }

        // === Real-time Resource Monitor === (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
let monitorInterval = null;
let processStartTime = null;
let filesProcessed = 0;
let totalBytesProcessed = 0;

function createResourceMonitorUI() {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ monitor ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (document.getElementById('resourceMonitor')) return;
    
    const monitorDiv = document.createElement('div');
    monitorDiv.id = 'resourceMonitor';
    monitorDiv.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 320px;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: #fff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        font-family: 'Courier New', monospace;
        font-size: 12px;
        z-index: 10000;
        transition: all 0.3s ease;
    `;
    
    monitorDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="margin: 0; font-size: 14px;">üìä Resource Monitor</h4>
            <button onclick="toggleMonitor()" style="
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                padding: 2px 8px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 10px;
            ">‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢</button>
        </div>
        <div id="monitorContent">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <strong>Memory:</strong><br>
                    <span id="memUsage" style="font-size: 16px; color: #4fc3f7;">0</span> MB
                </div>
                <div>
                    <strong>CPU Time:</strong><br>
                    <span id="cpuTime" style="font-size: 16px; color: #81c784;">0</span> s
                </div>
                <div>
                    <strong>Files:</strong><br>
                    <span id="fileCount" style="font-size: 16px; color: #ffb74d;">0</span> / <span id="totalFiles">0</span>
                </div>
                <div>
                    <strong>Speed:</strong><br>
                    <span id="processSpeed" style="font-size: 16px; color: #ba68c8;">0</span> f/min
                </div>
            </div>
            <hr style="margin: 10px 0; border: 1px solid rgba(255,255,255,0.2);">
            <div>
                <strong>Progress:</strong>
                <div style="background: rgba(255,255,255,0.2); border-radius: 5px; overflow: hidden; margin-top: 5px;">
                    <div id="progressBar" style="
                        height: 20px;
                        background: linear-gradient(90deg, #4fc3f7, #81c784);
                        width: 0%;
                        transition: width 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 11px;
                    ">0%</div>
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 10px; color: rgba(255,255,255,0.7);">
                <div>Heap Limit: <span id="heapLimit">0</span> MB</div>
                <div>Network: <span id="bandwidth">0</span> KB/s</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(monitorDiv);
    startMonitoring();
    }

    function startMonitoring() {
        if (monitorInterval) clearInterval(monitorInterval);
        
        monitorInterval = setInterval(() => {
            updateMonitorDisplay();
        }, 500); // Update every 500ms
    }

    function updateMonitorDisplay() {
        // Memory usage
        if (performance.memory) {
            const memUsed = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
            const memLimit = (performance.memory.jsHeapSizeLimit / 1024 / 1024).toFixed(0);
            document.getElementById('memUsage').textContent = memUsed;
            document.getElementById('heapLimit').textContent = memLimit;
        }
        
        // CPU time
        if (processStartTime) {
            const elapsed = ((Date.now() - processStartTime) / 1000).toFixed(1);
            document.getElementById('cpuTime').textContent = elapsed;
        }
        
        // Files count
        document.getElementById('fileCount').textContent = filesProcessed;
        
        // Processing speed
        if (processStartTime && filesProcessed > 0) {
            const elapsedMin = (Date.now() - processStartTime) / 60000;
            const speed = (filesProcessed / elapsedMin).toFixed(1);
            document.getElementById('processSpeed').textContent = speed;
        }
        
        // Bandwidth (approximate)
        if (totalBytesProcessed > 0 && processStartTime) {
            const elapsedSec = (Date.now() - processStartTime) / 1000;
            const bandwidth = ((totalBytesProcessed / 1024) / elapsedSec).toFixed(1);
            document.getElementById('bandwidth').textContent = bandwidth;
        }
    }

    function toggleMonitor() {
        const content = document.getElementById('monitorContent');
        const monitor = document.getElementById('resourceMonitor');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            monitor.style.width = '320px';
        } else {
            content.style.display = 'none';
            monitor.style.width = '150px';
        }
    }

    function stopMonitoring() {
        if (monitorInterval) {
            clearInterval(monitorInterval);
            monitorInterval = null;
        }
    }

    function removeMonitor() {
        stopMonitoring();
        const monitor = document.getElementById('resourceMonitor');
        if (monitor) monitor.remove();
    }

        // === Initialize on Load ===
        window.onload = function() {
            log('Application starting with integrated bill processing...');
            
            // Check configuration
            if (!CONFIG.CLIENT_ID || CONFIG.CLIENT_ID.includes('YOUR_')) {
                setStatus(configStatus, '‚ùå CLIENT_ID ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', 'error');
                log('Configuration incomplete - please check CLIENT_ID', 'error');
                return;
            } else {
                setStatus(configStatus, '‚úÖ OAuth Configuration ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á API Key)', 'success');
                log('OAuth Configuration OK - no API Key needed', 'success');
            }
            
            // Wait for Google Identity Services to load
            const checkGoogleIdentity = setInterval(() => {
                if (window.google && window.google.accounts) {
                    clearInterval(checkGoogleIdentity);
                    initializeGoogleIdentity();
                }
            }, 100);
            
            log('Application initialization completed');
        };
        
    </script>
</body>
</html>