<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Calculator with Google Drive Integration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 15px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .btn {
            padding: 12px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .btn-google {
            background: linear-gradient(135deg, #ea4335 0%, #fbbc05 100%);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        .debug-log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status.success { background: #e8f5e8; color: #2e7d32; border-left: 4px solid #4caf50; }
        .status.error { background: #ffebee; color: #c62828; border-left: 4px solid #f44336; }
        .status.warning { background: #fff3e0; color: #f57c00; border-left: 4px solid #ff9800; }
        .status.info { background: #e3f2fd; color: #1565c0; border-left: 4px solid #2196f3; }
        
        /* Google Sign-in Button Container */
        #googleSignInDiv {
            margin: 10px 0;
        }
        
        /* File Upload Area */
        .file-upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .file-upload-area:hover {
            border-color: #4facfe;
            background: #e3f2fd;
        }
        
        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            top: 0;
            left: 0;
        }
        
        .selected-files {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .selected-files .file-item {
            padding: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        /* Results Section */
        .results-container {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .result-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 3px 12px rgba(17, 153, 142, 0.3);
        }
        
        /* Table Styles */
        .horizontal-table-container {
            margin: 15px 0;
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .horizontal-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .horizontal-table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            font-size: 11px;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .horizontal-table tbody td {
            padding: 8px 6px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
            font-size: 11px;
            text-align: center;
            color: #333;
        }
        
        .horizontal-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .loading-container {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #ddd;
            border-top: 2px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .raw-data-container {
            max-height: 150px;
            overflow-y: auto;
            background: #f4f4f4;
            padding: 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßæ Bill Calculator with Google Drive</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ö‡∏¥‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive</p>
        </div>

        <!-- Configuration Status -->
        <div class="section">
            <h3>üìä Configuration Status</h3>
            <div id="configStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
        </div>

        <!-- Google API Status -->
        <div class="section">
            <h3>üîê Google OAuth Status</h3>
            <div id="googleSignInDiv"></div>
            <button class="btn btn-google" id="signOutBtn" style="display:none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            <div id="googleApiStatus" class="status info">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö...</div>
            <div id="userInfo" style="margin-top: 10px;"></div>
        </div>

        <!-- Google Drive Integration -->
        <div class="section">
            <h3>‚òÅÔ∏è Google Drive Integration</h3>
            <input type="url" id="googleDriveUrl" class="input" 
                placeholder="https://drive.google.com/drive/folders/..." 
                value="https://drive.google.com/drive/folders/1sSJdactN9akdC4cC93y9KuspmsaykDZh?usp=drive_link">
            <button class="btn btn-primary" id="fetchDriveBtn" disabled>üì• ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Drive</button>
            <div id="driveStatus" class="status info">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
        </div>

        <!-- File Upload Area -->
        <div class="section">
            <h3>üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ö‡∏¥‡∏•</h3>
            <div class="file-upload-area" id="fileUploadArea">
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                <span style="font-size: 48px;">üìÑ</span>
                <p><strong>‡∏Ñ‡∏•‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ Ctrl+V ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</strong></p>
                <p style="font-size: 12px; color: #666;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: JPG, PNG, WebP</p>
            </div>
            <div id="selectedFilesList" style="display:none;" class="selected-files"></div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-success" id="processBtn" disabled style="font-size: 16px; padding: 15px 30px;">
                    ‚ö° ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ MCP
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="section" id="resultsSection" style="display:none;">
            <h3>üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h3>
            <div id="resultsContainer" class="results-container"></div>
        </div>

        <!-- Debug Log -->
        <div class="section">
            <h3>üìã Debug Log</h3>
            <button class="btn" onclick="clearDebugLog()">üßπ Clear Log</button>
            <div id="debugLog" class="debug-log">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö...
</div>
        </div>
    </div>

    <!-- Google Identity Services ‡πÅ‡∏•‡∏∞ GAPI -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <script>
        // === OAuth Configuration ===
        const CONFIG = {
            CLIENT_ID: "171730649633-qaa4lhi484g7srrbot6p394jq7an35h7.apps.googleusercontent.com",
            DISCOVERY_DOCS: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
            SCOPES: "https://www.googleapis.com/auth/drive.readonly"
        };

        // === Global Variables ===
        let tokenClient;
        let accessToken = null;
        let selectedFiles = [];
        let driveFiles = [];

        // === DOM Elements ===
        const configStatus = document.getElementById('configStatus');
        const googleApiStatus = document.getElementById('googleApiStatus');
        const googleDriveUrl = document.getElementById('googleDriveUrl');
        const fetchDriveBtn = document.getElementById('fetchDriveBtn');
        const driveStatus = document.getElementById('driveStatus');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const debugLog = document.getElementById('debugLog');
        const userInfo = document.getElementById('userInfo');
        const signOutBtn = document.getElementById('signOutBtn');
        const selectedFilesList = document.getElementById('selectedFilesList');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsSection = document.getElementById('resultsSection');

        // === Debug Functions ===
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            debugLog.textContent += logMessage;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(logMessage);
        }

        function setStatus(element, message, type = 'info') {
            element.className = `status ${type}`;
            element.textContent = message;
            log(`Status Update (${element.id}): ${message}`, type);
        }

        function clearDebugLog() {
            debugLog.textContent = 'Debug log cleared.\n';
        }

        // === Initialize Google Identity Services ===
        function initializeGoogleIdentity() {
            log('Initializing Google Identity Services...');
            
            // Initialize for ID token (sign-in)
            google.accounts.id.initialize({
                client_id: CONFIG.CLIENT_ID,
                callback: handleCredentialResponse,
                auto_select: false
            });

            // Render Sign-in button
            google.accounts.id.renderButton(
                document.getElementById('googleSignInDiv'),
                { 
                    theme: "outline", 
                    size: "large",
                    text: "signin_with",
                    shape: "rectangular",
                    width: 250
                }
            );

            // Initialize OAuth2 token client for Drive API access
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: (tokenResponse) => {
                    log('OAuth token received successfully');
                    accessToken = tokenResponse.access_token;
                    
                    // Initialize GAPI client with the token
                    initializeGapiClient();
                },
            });

            setStatus(googleApiStatus, '‚úÖ Google Identity Services ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
            log('Google Identity Services initialized successfully');
        }

        // === Handle Sign-in Response ===
        function handleCredentialResponse(response) {
            log('Received credential response');
            if (response.credential) {
                // Decode JWT token to get user info
                const responsePayload = decodeJwtResponse(response.credential);
                
                userInfo.innerHTML = `
                    <strong>Signed in as:</strong> ${responsePayload.name} (${responsePayload.email})
                `;
                
                setStatus(googleApiStatus, '‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Drive...', 'success');
                
                // Show sign out button
                signOutBtn.style.display = 'inline-block';
                
                // After successful sign-in, request OAuth token for Drive access
                tokenClient.requestAccessToken();
            }
        }

        // === Decode JWT Token ===
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // === Initialize GAPI Client ===
        function initializeGapiClient() {
            log('Initializing GAPI client...');
            
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        discoveryDocs: CONFIG.DISCOVERY_DOCS
                    });
                    
                    // Set the access token
                    gapi.client.setToken({
                        access_token: accessToken
                    });
                    
                    log('GAPI client initialized successfully');
                    fetchDriveBtn.disabled = false;
                    setStatus(googleApiStatus, '‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Drive API', 'success');
                    
                } catch (error) {
                    log(`Failed to initialize GAPI client: ${error.message}`, 'error');
                    setStatus(googleApiStatus, `‚ùå GAPI init failed: ${error.message}`, 'error');
                }
            });
        }

        // === Sign Out ===
        signOutBtn.addEventListener('click', () => {
            google.accounts.id.disableAutoSelect();
            
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    log('Successfully signed out');
                    accessToken = null;
                    userInfo.innerHTML = '';
                    signOutBtn.style.display = 'none';
                    fetchDriveBtn.disabled = true;
                    setStatus(googleApiStatus, '‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'warning');
                });
            }
            
            // Reload to reset the sign-in button
            location.reload();
        });

        // === Fetch from Google Drive ===
        fetchDriveBtn.addEventListener('click', async () => {
            const url = googleDriveUrl.value.trim();
            
            if (!url) {
                setStatus(driveStatus, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL Google Drive', 'error');
                return;
            }
            
            const folderId = extractFolderId(url);
            if (!folderId) {
                setStatus(driveStatus, '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á Folder ID ‡πÑ‡∏î‡πâ', 'error');
                return;
            }
            
            log(`Extracting folder ID: ${folderId}`);
            
            fetchDriveBtn.disabled = true;
            fetchDriveBtn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            setStatus(driveStatus, '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå...', 'info');
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and (mimeType contains 'image/')`,
                    fields: 'files(id, name, mimeType, webContentLink, size)',
                    pageSize: 100
                });
                
                const files = response.result.files;
                log(`Found ${files.length} image files`);
                
                if (!files || files.length === 0) {
                    setStatus(driveStatus, '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Folder ‡∏ô‡∏µ‡πâ', 'warning');
                    return;
                }
                
                setStatus(driveStatus, `‚úÖ ‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${files.length} ‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...`, 'success');
                
                // Download files
                driveFiles = [];
                const downloadPromises = files.map(async (file, index) => {
                    try {
                        log(`Downloading file ${index + 1}/${files.length}: ${file.name}`);
                        
                        const resp = await gapi.client.drive.files.get({
                            fileId: file.id,
                            alt: 'media'
                        });
                        
                        // Convert response to blob
                        const blob = new Blob([resp.body], { type: file.mimeType });
                        const fileObj = new File([blob], file.name, { type: file.mimeType });
                        
                        return fileObj;
                        
                    } catch (error) {
                        log(`Failed to download ${file.name}: ${error.message}`, 'error');
                        return null;
                    }
                });
                
                const downloadedFiles = await Promise.all(downloadPromises);
                driveFiles = downloadedFiles.filter(f => f !== null);
                
                if (driveFiles.length > 0) {
                    // Add to selected files
                    selectedFiles = [...selectedFiles, ...driveFiles];
                    updateSelectedFilesList();
                    setStatus(driveStatus, `‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${driveFiles.length} ‡πÑ‡∏ü‡∏•‡πå`, 'success');
                    log(`Ready to process ${driveFiles.length} files from Drive`);
                }
                
            } catch (error) {
                log(`Drive fetch error: ${error.message}`, 'error');
                setStatus(driveStatus, `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            } finally {
                fetchDriveBtn.disabled = false;
                fetchDriveBtn.textContent = 'üì• ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Drive';
            }
        });

        // === Extract Folder ID ===
        function extractFolderId(url) {
            const patterns = [
                /\/folders\/([a-zA-Z0-9-_]+)/,
                /[?&]id=([a-zA-Z0-9-_]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        // === File Input Handler ===
        fileInput.addEventListener('change', (event) => {
            const files = Array.from(event.target.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 0) {
                selectedFiles = [...selectedFiles, ...files];
                updateSelectedFilesList();
                log(`Selected ${files.length} files via file input`);
            }
        });

        // === Handle Paste Event ===
        document.addEventListener('paste', async (e) => {
            const dt = e.clipboardData || window.clipboardData;
            if (!dt) return;

            const files = [];
            if (dt.items && dt.items.length) {
                for (const item of dt.items) {
                    if (item.type && item.type.startsWith('image/')) {
                        const blob = item.getAsFile();
                        if (blob) {
                            const ext = blob.type.split('/')[1] || 'png';
                            const file = new File([blob], `pasted_${Date.now()}.${ext}`, { type: blob.type });
                            files.push(file);
                        }
                    }
                }
            }
            
            if (files.length > 0) {
                selectedFiles = [...selectedFiles, ...files];
                updateSelectedFilesList();
                log(`Pasted ${files.length} files from clipboard`);
                e.preventDefault();
            }
        });

        // === Update Selected Files List ===
        function updateSelectedFilesList() {
            if (selectedFiles.length === 0) {
                selectedFilesList.style.display = 'none';
                processBtn.disabled = true;
                return;
            }
            
            selectedFilesList.style.display = 'block';
            let html = `<strong>üì∏ ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (${selectedFiles.length} ‡πÑ‡∏ü‡∏•‡πå):</strong><br>`;
            
            selectedFiles.forEach((file, index) => {
                const kb = Math.round(file.size / 1024);
                const source = file.name.startsWith('pasted_') ? 'üìã' : 'üì∑';
                html += `<div class="file-item">${source} ${file.name} (${kb} KB)</div>`;
            });
            
            selectedFilesList.innerHTML = html;
            processBtn.disabled = false;
        }

        // === Process Files ===
        processBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;

            processBtn.disabled = true;
            processBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
            resultsSection.style.display = 'block';
            resultsContainer.innerHTML = '';

            const startTimeAll = Date.now();
            const startDateAll = new Date(startTimeAll).toLocaleString('th-TH');

            for (const file of selectedFiles) {
                await processSingleFile(file);
            }

            const endTimeAll = Date.now();
            const endDateAll = new Date(endTimeAll).toLocaleString('th-TH');
            const durationAllSec = ((endTimeAll - startTimeAll) / 1000).toFixed(2);
            const durationAllMin = (durationAllSec / 60).toFixed(2);

            createTotalSummaryMessage({
                fileCount: selectedFiles.length,
                startDateAll,
                endDateAll,
                durationAllSec,
                durationAllMin
            });

            processBtn.disabled = false;
            processBtn.textContent = '‚ö° ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ MCP';
            
            // Clear selected files after processing
            selectedFiles = [];
            updateSelectedFilesList();
        });

        // === Process Single File ===
        async function processSingleFile(file) {
            const startTime = Date.now();
            const startDateStr = new Date(startTime).toLocaleString('th-TH');

            const formData = new FormData();
            formData.append('file', file);

            // Show loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'result-card';
            loadingDiv.id = `processing_${file.name}`;
            loadingDiv.innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå: <strong>${escapeHtml(file.name)}</strong>
                </div>`;
            resultsContainer.appendChild(loadingDiv);

            try {
                const res = await fetch('https://allie-capacitive-kaiden.ngrok-free.app/webhook/aip1', {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();
                document.getElementById(`processing_${file.name}`)?.remove();

                const payload = Array.isArray(data) ? data[0] : data;
                if (!payload || typeof payload !== 'object') {
                    throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }

                const endTime = Date.now();
                const endDateStr = new Date(endTime).toLocaleString('th-TH');
                const durationSec = ((endTime - startTime) / 1000).toFixed(2);

                createResultMessage(file.name, payload, { startDateStr, endDateStr, durationSec });

            } catch (error) {
                document.getElementById(`processing_${file.name}`)?.remove();
                const errorDiv = document.createElement('div');
                errorDiv.className = 'result-card';
                errorDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå <strong>${escapeHtml(file.name)}</strong><br>
                        <small>${escapeHtml(error.message || String(error))}</small>
                    </div>`;
                resultsContainer.appendChild(errorDiv);
            }
        }

        // === Create Result Message ===
        function createResultMessage(fileName, payload, timeInfo = null) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result-card';
            
            let html = `
                <div class="summary-card">
                    <h3>üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå: ${escapeHtml(fileName)}</h3>
                </div>`;

            if (timeInfo) {
                html += `
                    <div style="margin:6px 0; font-size:12px;">
                        üü¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°: ${escapeHtml(timeInfo.startDateStr)}<br>
                        üî¥ ‡∏à‡∏ö: ${escapeHtml(timeInfo.endDateStr)}<br>
                        ‚è± ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${escapeHtml(timeInfo.durationSec)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    </div>`;
            }

            // Display data in table format
            html += createHorizontalDataTable(payload);

            // Export buttons
            html += `
                <div style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick='exportToCSV(${JSON.stringify(payload)})'>
                        üìä Export CSV
                    </button>
                    <button class="btn btn-primary" onclick='exportToJSON(${JSON.stringify(payload)})'>
                        üìÑ Export JSON
                    </button>
                </div>`;

            // Raw data
            html += `
                <details style="margin-top: 10px;">
                    <summary style="cursor: pointer;">üîç Raw Data</summary>
                    <div class="raw-data-container">${escapeHtml(JSON.stringify(payload, null, 2))}</div>
                </details>`;

            resultDiv.innerHTML = html;
            resultsContainer.appendChild(resultDiv);
        }

        // === Create Horizontal Data Table ===
        function createHorizontalDataTable(data) {
            if (!data || typeof data !== 'object') return '';
            
            let html = '';
            
            // Categorize data
            const sections = categorizeData(data);
            
            // Display each section
            for (const [sectionName, sectionData] of Object.entries(sections)) {
                if (Array.isArray(sectionData) && sectionData.length > 0) {
                    html += createArrayTable(sectionName, sectionData);
                } else if (typeof sectionData === 'object' && Object.keys(sectionData).length > 0) {
                    html += createObjectTable(sectionName, sectionData);
                }
            }
            
            return html;
        }

        // === Categorize Data ===
        function categorizeData(data) {
            const sections = {};
            
            for (const [key, value] of Object.entries(data)) {
                if (Array.isArray(value)) {
                    sections[key] = value;
                } else if (typeof value === 'object' && value !== null) {
                    sections[key] = value;
                } else {
                    if (!sections['‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ']) sections['‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'] = {};
                    sections['‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'][key] = value;
                }
            }
            
            return sections;
        }

        // === Create Array Table ===
        function createArrayTable(title, arrayData) {
            if (!arrayData || arrayData.length === 0) return '';
            
            const headers = Object.keys(arrayData[0]);
            let html = `
                <div style="margin-top: 15px;">
                    <h4>üì¶ ${escapeHtml(title)}</h4>
                    <div class="horizontal-table-container">
                        <table class="horizontal-table">
                            <thead>
                                <tr>`;
            
            headers.forEach(header => {
                html += `<th>${escapeHtml(header)}</th>`;
            });
            
            html += `</tr></thead><tbody>`;
            
            arrayData.forEach(item => {
                html += `<tr>`;
                headers.forEach(header => {
                    const value = item[header] ?? '';
                    html += `<td title="${escapeHtml(String(value))}">${escapeHtml(String(value))}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `</tbody></table></div></div>`;
            return html;
        }

        // === Create Object Table ===
        function createObjectTable(title, objectData) {
            if (!objectData || Object.keys(objectData).length === 0) return '';
            
            const entries = Object.entries(objectData);
            const headers = entries.map(([key]) => key);
            const values = entries.map(([, value]) => {
                if (typeof value === 'object' && value !== null) {
                    return JSON.stringify(value);
                }
                return String(value ?? '');
            });
            
            let html = `
                <div style="margin-top: 15px;">
                    <h4>üìã ${escapeHtml(title)}</h4>
                    <div class="horizontal-table-container">
                        <table class="horizontal-table">
                            <thead>
                                <tr>`;
            
            headers.forEach(header => {
                html += `<th>${escapeHtml(header)}</th>`;
            });
            
            html += `</tr></thead><tbody><tr>`;
            
            values.forEach(value => {
                html += `<td title="${escapeHtml(value)}">${escapeHtml(value)}</td>`;
            });
            
            html += `</tr></tbody></table></div></div>`;
            return html;
        }

        // === Create Total Summary Message ===
        function createTotalSummaryMessage(info) {
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'result-card';
            summaryDiv.innerHTML = `
                <div class="summary-card" style="background: linear-gradient(135deg,#ff512f 0%,#dd2476 100%);">
                    <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <div>‚úÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: ${info.fileCount} ‡πÑ‡∏ü‡∏•‡πå</div>
                    <div style="margin-top:8px; font-size:13px;">
                        üü¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${escapeHtml(info.startDateAll)}<br>
                        üî¥ ‡∏à‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${escapeHtml(info.endDateAll)}<br>
                        ‚è± ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${escapeHtml(info.durationAllSec)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (~${escapeHtml(info.durationAllMin)} ‡∏ô‡∏≤‡∏ó‡∏µ)
                    </div>
                </div>`;
            resultsContainer.appendChild(summaryDiv);
        }

        // === Export Functions ===
        function exportToCSV(data) {
            try {
                const csvData = flattenObjectForCSV(data);
                const headers = Object.keys(csvData);
                const values = headers.map(h => `"${String(csvData[h] ?? '').replace(/"/g, '""')}"`);
                
                const csvContent = [headers.join(','), values.join(',')].join('\n');
                downloadFile(csvContent, 'text/csv', 'invoice_data.csv');
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Export CSV');
                log(`Export CSV error: ${error.message}`, 'error');
            }
        }

        function exportToJSON(data) {
            try {
                const jsonContent = JSON.stringify(data, null, 2);
                downloadFile(jsonContent, 'application/json', 'invoice_data.json');
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Export JSON');
                log(`Export JSON error: ${error.message}`, 'error');
            }
        }

        function flattenObjectForCSV(obj, prefix = '') {
            let result = {};
            
            for (const [key, value] of Object.entries(obj)) {
                const newKey = prefix ? `${prefix}_${key}` : key;
                
                if (Array.isArray(value)) {
                    result[newKey] = JSON.stringify(value);
                } else if (typeof value === 'object' && value !== null) {
                    Object.assign(result, flattenObjectForCSV(value, newKey));
                } else {
                    result[newKey] = value;
                }
            }
            
            return result;
        }

        function downloadFile(content, mimeType, fileName) {
            const blob = new Blob([content], { type: `${mimeType};charset=utf-8;` });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // === Helper Functions ===
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // === Initialize on Load ===
        window.onload = function() {
            log('Application starting with integrated bill processing...');
            
            // Check configuration
            if (!CONFIG.CLIENT_ID || CONFIG.CLIENT_ID.includes('YOUR_')) {
                setStatus(configStatus, '‚ùå CLIENT_ID ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', 'error');
                log('Configuration incomplete - please check CLIENT_ID', 'error');
                return;
            } else {
                setStatus(configStatus, '‚úÖ OAuth Configuration ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á API Key)', 'success');
                log('OAuth Configuration OK - no API Key needed', 'success');
            }
            
            // Wait for Google Identity Services to load
            const checkGoogleIdentity = setInterval(() => {
                if (window.google && window.google.accounts) {
                    clearInterval(checkGoogleIdentity);
                    initializeGoogleIdentity();
                }
            }, 100);
            
            log('Application initialization completed');
        };
    </script>
</body>
</html>